function GenericShimuraCurve237()
  K<t> := PolynomialRing(QQ);
  S<x> := PolynomialRing(K);
  f := (t - 27/16)*x^10 - 567/64*x^9 - 189/4*t*x^8 + (-84*t^2 - 189/4*t)*x^7 - 189*t^2*x^6 - 189/2*t^2*x^5 + 84*t^3*x^4 + 108*t^3*x^3 - 28*t^4*x;
  return f;
end function;

function GenericShimuraCurve239()
  K<t> := PolynomialRing(QQ);
  S<X,Y,Z,T> := PolynomialRing(K, 4);
  Q := X*Z - Y^2;
  E := 3*T^3 + t*(t - 1)*(3*T*(5*X^2 + 6*X*Y + 2*t*Y*Z + 3*t*Z^2) + (-2*t + 9)*X^3 + 22*t*X^2*Y + 21*t*X^2*Z + (-14*t^2 + 18*t)*X*Y*Z + t^2*X*Z^2 + 6*t^2*Y*Z^2 + (-3*t^3 + 6*t^2)*Z^3);
  return Q, E;
end function;

function GetShimuraCurve237(param)
  f := GenericShimuraCurve237();
  S<x> := PolynomialRing(Parent(param));
  return &+[Evaluate(c, param)*x^(i-1) : i->c in Coefficients(f)];
end function;

function GetShimuraCurve239(param)
  Q, E := GenericShimuraCurve239();
  S<X,Y,Z,T> := PolynomialRing(Parent(param), 4);
  Coeff, Mon := CoefficientsAndMonomials(E);
  return S!Q, Polynomial([Evaluate(c, param) : c in Coefficients(E)], ChangeUniverse(Mon, S));
end function;

// Shimura curves
function IsOnShimura237(f : epsilon := Precision(BaseRing(Parent(f))) div 2)
    invs_f, wgt := InvariantsGenus4Curves(f);
    wgt_even := [w : w in wgt | w mod 2 eq 0];
    invs_even := [inv : i->inv in invs_f | wgt[i] mod 2 eq 0]; 
    invs_norm := Normalize(invs_even, wgt_even);
    mu := invs_norm[4];
    invs_shim := 
    [0,
    0,
    8/225*mu,
    mu,
    9555/1552661*mu,
    -136/7425*mu,
    -136/7425*mu,
    22321/1111320*mu,
    41905/373527*mu,
    -1088/121275*mu,
    32453/271656*mu,
    9378917/16180819200*mu,
    -80580799/82771113600*mu,
    3965075087/373776923520*mu,
    -10106041/343429632000*mu,
    6679079/135136512000*mu,
    8415/33575584*mu,
    6432239/92989769600*mu,
    2964307/10679340672*mu,
    799098587/649689064113375*mu^2,
    -35403551/965268798243750*mu^2,
    -737872919/3467287952689275*mu^2,
    104367704/1449535097278125*mu^2 - 27781896571/2628148399027200*mu,
    202166944/543307229053875*mu^2 - 47535787/533045971584*mu,
    24971192/1353269001459375*mu^2 - 1527999253/419581586511360*mu,
    -13955952/19843977993125*mu^2 + 82387485713/827109665907840*mu,
    -33747224/55202338780875*mu^2 - 6182478247/708951142206720*mu,
    45834047/222225660421875*mu^2 - 38197116529/1618258041993600*mu,
    88783492/83293469758125*mu^2 - 91289913/875248323712*mu,
    -112232344/6243925288535*mu^2 + 8403525/51353855728*mu,
    59920516/113310063813375*mu^2 - 146795/4506427296*mu,
    -61538022538343/300181687280798400000*mu^2 + 21026458789611847/4307290703943769350144*mu,
    419176166767579/550333093348130400000*mu^2 - 2817979013040763/89735222998828528128*mu,
    17360603883629/83274086493467100000*mu^2 + 1125455259401629/27156712223329686144*mu,
    92179526694239/150090843640399200000*mu^2 - 52350137286370495/2153645351971884675072*mu,
    1397787163426537/1284110551145637600000*mu^2 - 8124306944780585/209382186997266565632*mu,
    1918564676253251/22623693164729506080000*mu^2 - 57104093245637555/11934784658844194241024*mu,
    36255126482249/431511175466147700000*mu^2 + 88287259051679129/24766921547676673763328*mu,
    1096637001599/35086171240612800000*mu^2 + 402739710504703/1926241805490381324288*mu,
    -5117181688447/64324647274456800000*mu^2 - 53975425119187/40130037614382944256*mu,
    -20211972884261/126533352204359100000*mu^2 + 21556912169221/12144616646457996288*mu,
    -15266198370251/228060113063983200000*mu^2 - 1002711837811255/963120902745190662144*mu,
    -19578822922741/150090843640399200000*mu^2 - 155612557479665/93636754433560203264*mu,
    -9230069858983/327836412529475850000*mu^2 + 1691049620266721/11075890381569692614656*mu,
    169805623/20391829387776000*mu^2,
    -89401/105931581235200*mu^2,
    237610238567/1567601492355892224000*mu^2,
    -1524484215210463/6342919314726500352000*mu^2,
    -7661196259085981/74138017964335718400000*mu^2,
    -7753465235717563/14684835500764910910000000*mu^3 + 960201643633802107/1494684528918996602880000*mu^2];
    RealField(10)!Max([Abs(invs_shim[i]-invs_norm[i]) : i in [1..#invs_shim]]);
    return Max([Abs(invs_shim[i]-invs_norm[i]) : i in [1..#invs_shim]]) lt epsilon;
end function;


function IsOnShimura239(Q, E : epsilon := Precision(BaseRing(Parent(Q))) div 2)
    invs, wgt := InvariantsGenus4Curves(Q, E);
    wgt_even := [w : w in wgt | w mod 2 eq 0];
    invs_even := [inv : i->inv in invs | wgt[i] mod 2 eq 0]; 
    invs_norm := WPSMultiply([w div 2 : w in wgt_even], invs_even, invs[6]/invs[1]);
    a := invs[7]/invs[1];
    t := (918*a-3645)/(22*a+675);
    invs_norm := WPSMultiply([w div 2 : w in wgt_even], invs_norm, t - 459/11);
    invs_shim := 
    [27993600/121*t^2 - 12849062400/1331*t,
    1285255879616102400/1771561*t^4 - 20727258712060723200/1771561*t^3 + 47773803616822886400/1771561*t^2,
    (-1057780806353666929852416000/2357947691*t^7 - 69036562852747652578148352000/2357947691*t^6 + 142262971116616290360360960000/2357947691*t^5 - 23530271027395257484443648000/2357947691*t^4 - 64995732397895607222534144000/2357947691*t^3)/(t - 1),
    (-805843923808602836433716828482041387417600000/4177248169415651*t^11 + 330466556219295694843070748382895149783449600000/4177248169415651*t^10 - 4511869205136927938289898451556156202549248000000/4177248169415651*t^9 + 12831626221377215408076540043158250019880960000000/4177248169415651*t^8 - 12621209594760747749272853342527540357496832000000/4177248169415651*t^7 + 4065845087742705548097826707107678435829350400000/4177248169415651*t^6 - 499032860706745331041074389321865507530342400000/4177248169415651*t^5)/(t - 1),
    27993600/121*t,
    -9447840000/1331*t^2 - 51018336000/1331*t,
    18575209267200/14641*t^2,
    -149780038975488000/1127357*t^3 + 12694994583552000/1127357*t^2,
    34271261097984000/161051*t^3 - 67706637778944000/161051*t^2,
    -28633949596368764928000/19487171*t^4 - 16847578091810193408000/19487171*t^3,
    -18601693452288000000/1771561*t^4 + 120158123733319680000/12400927*t^3 + 33419573241200640000/1771561*t^2,
    14651822206985011200000/136410197*t^4 - 23904040051099238400000/136410197*t^3 - 25630241939597721600000/136410197*t^2,
    -17805491603106693120000000/1500512167*t^4 + 99703440660517355520000000/1500512167*t^3,
    170376983306934681600000/19487171*t^4 - 19743255576340070400000/1771561*t^3,
    -32799738607259363573760000/214358881*t^5 + 314207331412260107059200000/214358881*t^4 - 211521342942676978237440000/214358881*t^3,
    940209514651689167093760000/1500512167*t^5 - 2717893416716049926062080000/1500512167*t^4 + 888730803815602465013760000/1500512167*t^3,
    (114192463790740319336996536320000/25937424601*t^7 - 53020476585849416437758689280000/25937424601*t^6 - 588574976566204579906395832320000/25937424601*t^5 + 598066853542105538459106017280000/25937424601*t^4)/(t - 1),
    6972722728867219670197862400000/181561972207*t^6 - 46567155254908973616621158400000/181561972207*t^5 + 3937879195025562937589760000000/25937424601*t^4 + 11432285073558423770392166400000/25937424601*t^3,
    -17989560899771663646720000000/16505633837*t^5 - 80348140056252367503360000000/16505633837*t^4 - 92713834605103562096640000000/16505633837*t^3,
    -10282287504157908664320000000/2357947691*t^6 - 73154921806079778933964800000/2357947691*t^5 + 3999851536873203700649164800000/16505633837*t^4 - 87047855890038759673036800000/2357947691*t^3,
    13024230838600017641472000000/2357947691*t^6 - 51152406007627961597952000000/2357947691*t^5 - 31984074033670914048000000000/214358881*t^4 + 435239279450193798365184000000/2357947691*t^3,
    (441489837865289881941280492093440000/1997181694277*t^8 - 3451152821306850215045156799774720000/1997181694277*t^7 + 10361162615563640830844123637350400000/1997181694277*t^6 - 11541070526653540600752754686689280000/1997181694277*t^5 + 624675947212581801127993807994880000/285311670611*t^4)/(t - 1),
    (-26645055901462616907879913881600000/285311670611*t^8 - 397736254220307743643543797760000000/285311670611*t^7 + 1242366571673659120313533936435200000/285311670611*t^6 - 461602344376891251294732288000000000/285311670611*t^5 - 509016863805507929203585685913600000/285311670611*t^4)/(t - 1),
    6723048950243062541325434880000000/1997181694277*t^6 + 9184884451330735242876026880000000/285311670611*t^5 - 32312164106382387590631260160000000/285311670611*t^4,
    -1655445179791265355974836224000000/181561972207*t^6 + 1351203797333122283483430912000000/181561972207*t^5 - 7672149309988330452553826304000000/181561972207*t^4,
    (99025934388820893723915820746355507200000/34522712143931*t^9 - 1245229493729842104186542764236315033600000/34522712143931*t^8 + 22686070536740451546996883870187520000000/285311670611*t^7 - 112621592573936313507630163272558182400000/3138428376721*t^6 - 577304660147952111934569808959583027200000/34522712143931*t^5)/(t - 1),
    (9517851250952789110987476172800000000/3138428376721*t^9 - 3002754080256226164263392804601856000000/21968998637047*t^8 + 7494604130549700955414303466323968000000/21968998637047*t^7 - 3510587063155576484315688515665920000000/21968998637047*t^6 - 5970277877260679709119616928186368000000/21968998637047*t^5 + 491255424302507226993077589639168000000/3138428376721*t^4)/(t - 1),
    (3435704089157623298674630166839296000000/241658985007517*t^9 - 32075622166822775513198583764484096000000/241658985007517*t^8 + 108503017346437906628919387544879104000000/241658985007517*t^7 + 12155017095088907407587665529274368000000/241658985007517*t^6 - 34397503059512497559180009703211008000000/21968998637047*t^5 + 41049069323563074122195376210444288000000/34522712143931*t^4)/(t - 1),
    (582372713388705834068775321734199273062400000/2658248835082687*t^10 - 9010300535910379644588076174932183928012800000/2658248835082687*t^9 + 43191557060876923363913817426678891990220800000/2658248835082687*t^8 - 8416903160213464422998506644179476335820800000/241658985007517*t^7 + 95984283910804313363521355900963831729356800000/2658248835082687*t^6 - 5715402371845494896849459550663036056371200000/379749833583241*t^5)/(t - 1),
    (140940263391074395218206939906943222716301312000000/45949729863572161*t^11 - 2599030564698320362462272653038911943568523264000000/45949729863572161*t^10 + 15767451507715639569656343493838275127053123584000000/45949729863572161*t^9 - 34024271079698808906946170720438317679183396864000000/45949729863572161*t^8 + 28109121018390638965981440222023625507921199104000000/45949729863572161*t^7 - 6553225596006800910145308721405949420368822272000000/45949729863572161*t^6)/(t - 1)
    ];
    RealField(10)!Max([Abs(invs_shim[i]-invs_norm[i]) : i in [1..#invs_shim]]);
    return Max([Abs(invs_shim[i]-invs_norm[i]) : i in [1..#invs_shim]]) lt epsilon;
end function;

function GetParam237(f)
  c3 := Transvectant(f, f, 8);
  c4 := Transvectant(f, f, 6);
  c5 := Transvectant(f, f, 4);
  c6 := Transvectant(f, f, 2);
  c7 := Transvectant(c4, f, 8);
  c9 := Transvectant(c5, f, 8);
  c12 := Transvectant(c6, f, 7);
  c22 := Transvectant(c12, f, 9);

  i4 := Transvectant(c7, c7, 2);
  i6 := Transvectant(c3*c9, f, 10);
  i7 := Transvectant(c9*c22, f, 10);
  param := 1-Evaluate(i4*(i6/i7)^3, [0,0])*3794886144/359165724775;
  
  //FIXME do over exact fields also
  m0 := MinimalPolynomial(Real(param), 15);
  m1, base_chg := Polredbest(m0);
  
  K<mu0> := NumberField(m1);
  param1 := K!base_chg;
  m2, base_chg := Polredabs(m1);
  L<mu> := NumberField(m2);
  
  return Evaluate(PolynomialRing(L)!Flat(param1), L!base_chg);
end function;

function GetParam239(Q, E)
  invs, wgt := InvariantsGenus4Curves(Q, E);
  a := invs[7]/invs[1];
  param := (918*a-3645)/(22*a+675);

  //FIXME do over exact fields also
  m0 := MinimalPolynomial(Real(param), 21);
  m1, base_chg := Polredbest(m0);
  
  K<mu0> := NumberField(m1);
  param1 := K!base_chg;
  m2, base_chg := Polredabs(m1);
  L<mu> := NumberField(m2);
  
  return Evaluate(PolynomialRing(L)!Flat(param1), L!base_chg);
end function;

function GetShimuraCurve237(mu)
  L := Parent(mu);
  f := GenericShimuraCurve237();
  S<x> := PolynomialRing(FieldOfFractions(L));
  Coeff := Coefficients(f);
  return &+[Evaluate(Coeff[i], mu)*x^(i-1) : i in [1..#Coeff]];
end function;

function GetShimuraCurve239(mu)
  L := Parent(mu);
  Q, E := GenericShimuraCurve239();
  S<X,Y,Z,T> := PolynomialRing(FieldOfFractions(L), 4);
  Coeff, Mon := CoefficientsAndMonomials(E);
  return Evaluate(Q, [X,Y,Z,T]), &+[Evaluate(Coeff[i], mu)*Evaluate(Mon[i], [X,Y,Z,T]) : i in [1..#Coeff]];
end function;


function GetCurves237()
  R<x> := PolynomialRing(QQ);
  str := Read("~/github/Genus-4-RM-CM/examples/Shimura_237_param.m");
  str := Split(str, "\n");
  list_str := [Split(l, "|") : l in str];
  list_curves := [**];
  for l in list_str do
    K<mu> := NumberField(eval l[2]);
    Append(~list_curves, HyperellipticCurve(GetShimuraCurve237(eval l[3])));
  end for;
  return list_curves;
end function;

function GetCurves239()
  R<x> := PolynomialRing(QQ);
  str := Read("~/github/Genus-4-RM-CM/examples/Shimura_239_param.m");
  str := Split(str, "\n");
  list_str := [Split(l, "|") : l in str];
  list_curves := [**];
  for l in list_str do
    K<mu> := NumberField(eval l[2]);
    Q, E := GetShimuraCurve239(eval l[3]);
    Append(~list_curves, Curve(Proj(Parent(Q)), [Q, E]));
  end for;
  return list_curves;
end function;
